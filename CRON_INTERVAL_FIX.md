# رفع مشکل تغییر فاصله زمانی کرون جاب

## مشکل

وقتی فاصله زمانی (Update Interval) تغییر می‌کند، کرون جاب با فاصله زمانی جدید بازسازی نمی‌شود.

## راه‌حل اعمال شده

### 1. بهبود متد `schedule_cron()`

- حذف خودکار کرون جاب قبلی قبل از زمانبندی جدید
- استفاده از فاصله زمانی تنظیم شده در دیتابیس
- لاگ‌گیری بهتر برای تشخیص مشکلات

### 2. اضافه کردن Hook های WordPress

- `update_option_gicapi_cron_interval` - هنگام تغییر فاصله زمانی
- `update_option_gicapi_enable_cron_updates` - هنگام فعال/غیرفعال کردن

### 3. متدهای جدید

- `reschedule_cron_on_interval_change()` - بازسازی خودکار هنگام تغییر فاصله زمانی
- `reschedule_cron_on_enable_change()` - بازسازی خودکار هنگام تغییر وضعیت فعال/غیرفعال
- `check_and_repair_cron()` - بررسی و ترمیم خودکار مشکلات کرون جاب

### 4. ابزارهای دیباگ جدید

- دکمه "Check & Repair Cron Job" - بررسی و ترمیم خودکار
- بررسی خودکار هنگام بارگذاری صفحه تنظیمات
- لاگ‌گیری دقیق‌تر

## نحوه کارکرد

### هنگام تغییر فاصله زمانی:

1. کاربر فاصله زمانی را در تنظیمات تغییر می‌دهد
2. WordPress hook `update_option_gicapi_cron_interval` اجرا می‌شود
3. متد `reschedule_cron_on_interval_change()` فراخوانی می‌شود
4. کرون جاب قبلی حذف می‌شود
5. کرون جاب جدید با فاصله زمانی جدید زمانبندی می‌شود

### هنگام بارگذاری صفحه تنظیمات:

1. متد `check_and_repair_cron()` اجرا می‌شود
2. وضعیت فعلی کرون جاب بررسی می‌شود
3. اگر مشکلی وجود داشته باشد، به طور خودکار ترمیم می‌شود

## تست

### تست تغییر فاصله زمانی:

1. به بخش تنظیمات Gift-i-Card بروید
2. فاصله زمانی را تغییر دهید (مثلاً از 5 دقیقه به 15 دقیقه)
3. تنظیمات را ذخیره کنید
4. به تب "Cron Jobs" بروید
5. وضعیت "Next Run" را بررسی کنید - باید با فاصله زمانی جدید محاسبه شده باشد

### تست ابزارهای دیباگ:

1. دکمه "Check & Repair Cron Job" را کلیک کنید
2. پیام موفقیت باید نمایش داده شود
3. صفحه رفرش شود و وضعیت جدید نمایش داده شود

## لاگ‌ها

برای بررسی عملکرد، لاگ‌های زیر را دنبال کنید:

- `GICAPI Cron: Interval changed from X to Y, rescheduling cron`
- `GICAPI Cron: Cron job scheduled successfully with interval: X`
- `GICAPI Cron: Interval mismatch, rescheduling`

## نکات مهم

1. **تغییرات بلافاصله اعمال می‌شوند** - نیازی به انتظار نیست
2. **کرون جاب قبلی حذف می‌شود** - هیچ تداخلی وجود ندارد
3. **بررسی خودکار** - مشکلات به طور خودکار تشخیص و ترمیم می‌شوند
4. **لاگ‌گیری کامل** - تمام تغییرات در لاگ‌ها ثبت می‌شوند

## فایل‌های تغییر یافته

- `includes/class-gicapi-cron.php` - بهبود متدهای زمانبندی
- `admin/partials/settings/gicapi-settings-cron.php` - اضافه کردن ابزارهای دیباگ

## عیب‌یابی

اگر همچنان مشکل دارید:

1. لاگ‌های خطا را بررسی کنید
2. دکمه "Check & Repair Cron Job" را کلیک کنید
3. دکمه "Reschedule Cron Job" را کلیک کنید
4. تنظیمات API را بررسی کنید
