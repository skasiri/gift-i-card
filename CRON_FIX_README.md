# Gift-i-Card Cron Job Fix Guide

## مشکل

کرون جاب اجرا نمی‌شود و سفارشات به‌روزرسانی نمی‌شوند.

## راه‌حل‌های اعمال شده

### 1. بهبود کلاس GICAPI_Cron

- اضافه کردن لاگ‌گیری بهتر برای تشخیص مشکلات
- بهبود مدیریت زمان‌بندی کرون جاب
- اضافه کردن بررسی تنظیمات API
- اضافه کردن مدیریت خطا بهتر

### 2. اضافه کردن ابزارهای دیباگ

- دکمه "Reschedule Cron Job" برای بازسازی کرون جاب
- بررسی وضعیت کرون جاب در تنظیمات
- لاگ‌گیری دقیق‌تر برای تشخیص مشکلات

### 3. بهبود مدیریت تنظیمات

- بازسازی خودکار کرون جاب هنگام تغییر تنظیمات
- بررسی صحت تنظیمات API

## مراحل رفع مشکل

### مرحله 1: بررسی تنظیمات

1. به بخش تنظیمات Gift-i-Card بروید
2. به تب "Cron Jobs" بروید
3. مطمئن شوید که "Enable Automatic Order Updates" فعال است
4. فاصله زمانی را روی "Every 5 minutes" تنظیم کنید

### مرحله 2: بازسازی کرون جاب

1. روی دکمه "Reschedule Cron Job" کلیک کنید
2. منتظر بمانید تا پیام موفقیت نمایش داده شود
3. صفحه را رفرش کنید تا وضعیت جدید را ببینید

### مرحله 3: تست دستی

1. روی دکمه "Update Pending/Processing Orders Now" کلیک کنید
2. اگر پیام موفقیت دریافت کردید، کرون جاب کار می‌کند
3. اگر خطا دریافت کردید، مشکل در تنظیمات API است

### مرحله 4: بررسی لاگ‌ها

اگر همچنان مشکل دارید:

1. فایل error log سرور را بررسی کنید
2. دنبال پیام‌های "GICAPI Cron" بگردید
3. خطاهای احتمالی را بررسی کنید

## مشکلات احتمالی و راه‌حل

### مشکل 1: WordPress Cron غیرفعال

اگر `DISABLE_WP_CRON` در wp-config.php فعال است:

```php
define('DISABLE_WP_CRON', true);
```

راه‌حل: یک کرون جاب واقعی تنظیم کنید:

```bash
*/5 * * * * wget -q -O /dev/null "https://yoursite.com/wp-cron.php?doing_wp_cron"
```

### مشکل 2: تنظیمات API نادرست

1. Base URL را بررسی کنید
2. Consumer Key و Secret را بررسی کنید
3. اتصال به API را تست کنید

### مشکل 3: محدودیت‌های هاستینگ

برخی هاستینگ‌ها کرون جاب را محدود می‌کنند:

1. با پشتیبانی هاستینگ تماس بگیرید
2. از سرویس‌های خارجی مثل cron-job.org استفاده کنید

## تست نهایی

برای اطمینان از کارکرد صحیح:

1. یک سفارش تست ایجاد کنید
2. منتظر بمانید تا کرون جاب اجرا شود (حداکثر 5 دقیقه)
3. وضعیت سفارش را بررسی کنید
4. لاگ‌ها را برای پیام‌های موفقیت بررسی کنید

## فایل‌های تغییر یافته

- `includes/class-gicapi-cron.php` - بهبود کلاس کرون
- `includes/class-gicapi-api.php` - اضافه کردن متد is_configured
- `admin/partials/settings/gicapi-settings-cron.php` - اضافه کردن ابزارهای دیباگ
- `cron-debug.php` - اسکریپت دیباگ (اختیاری)

## نکات مهم

1. کرون جاب فقط سفارشات با وضعیت "pending" یا "processing" را به‌روزرسانی می‌کند
2. اگر سفارشی برای به‌روزرسانی وجود نداشته باشد، کرون جاب کاری انجام نمی‌دهد
3. لاگ‌ها در فایل error log سرور ذخیره می‌شوند
4. تغییرات تنظیمات بلافاصله اعمال می‌شوند

## پشتیبانی

اگر همچنان مشکل دارید:

1. لاگ‌های خطا را بررسی کنید
2. تنظیمات API را دوباره بررسی کنید
3. با پشتیبانی هاستینگ تماس بگیرید
4. از ابزارهای دیباگ استفاده کنید
